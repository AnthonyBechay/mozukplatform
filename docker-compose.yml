services:
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3001
      DATABASE_URL: '${DATABASE_URL}'
      JWT_SECRET: '${JWT_SECRET}'
    volumes:
      - backend_data:/app/uploads
    networks:
      - coolify
    healthcheck:
      test:
        - CMD
        - node
        - '-e'
        - "require('http').get('http://localhost:3001/api/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 120s
    command:
      - sh
      - '-c'
      - "npx prisma migrate deploy --schema=prisma/schema.prisma || echo 'Migration skipped' && node prisma/seed.js || echo 'Seed skipped' && node dist/index.js"

volumes:
  backend_data:
    driver: local

networks:
  coolify:
    external: true
